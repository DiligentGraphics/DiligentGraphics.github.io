<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diligent Engine: Depth of Field</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Diligent Engine
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d5/da1/DiligentFX_PostProcess_DepthOfField_README.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Depth of Field</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="https://github.com/DiligentGraphics/DiligentFX/raw/master/PostProcess/DepthOfField/media/depth_of_field.jpg" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md145"></a>
Table of contents</h2>
<ul>
<li>Introduction</li>
<li>Integration guidelines<ul>
<li>Input resources</li>
<li>Host API</li>
</ul>
</li>
<li>Implementation details</li>
<li><a class="el" href="../../de/d6b/README.html#references">References</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md146"></a>
Introduction</h2>
<p>Depth of Field is a visualization technique used in photography and cinematography to create a sense of depth by focusing on certain objects, while keeping others out-of-focus and blurred. In real-time rendering, accurately calculating the depth of field effect is prohibitvely expensive. Rasterization uses a pinhole camera model that makes all objects in the frame equally sharp. Therefore, in real-time rendering, depth of field is approximated by applying a blur effect to the final image, using the information from the depth buffer.</p>
<h2><a class="anchor" id="autotoc_md147"></a>
Integration guidelines</h2>
<h3><a class="anchor" id="autotoc_md148"></a>
Input resources</h3>
<p>The following table enumerates all external inputs required by the Depth Of Field effect.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><b>Name</b>   </th><th class="markdownTableHeadNone"><b>Format</b>   </th><th class="markdownTableHeadNone"><b>Notes</b>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Color buffer   </td><td class="markdownTableBodyNone"><code>APPLICATION SPECIFIED (3x FLOAT)</code>   </td><td class="markdownTableBodyNone">The HDR render target of the current frame containing the scene radiance    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Depth buffer   </td><td class="markdownTableBodyNone"><code>APPLICATION SPECIFIED (1x FLOAT)</code>   </td><td class="markdownTableBodyNone">The depth buffer for the current frame provided by the application. The data should be provided as a single floating-point value, the precision of which is under the application's control   </td></tr>
</table>
<p>The effect uses a number of parameters to control the quality and performance organized into the <code>HLSL::DepthOfFieldAttribs</code> structure. The following table lists the parameters and their descriptions.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><b>Name</b>   </th><th class="markdownTableHeadNone"><b>Notes</b>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MaxCircleOfConfusion</code>   </td><td class="markdownTableBodyNone">The maximum size of CoC in texture coordinates for a pixel.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>TemporalStabilityFactor</code>   </td><td class="markdownTableBodyNone">Stability of the temporal accumulation of the CoC.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>BokehKernelRingCount</code>   </td><td class="markdownTableBodyNone">The number of rings in the Octaweb kernel.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>BokehKernelRingDensity</code>   </td><td class="markdownTableBodyNone">The number of samples within each ring of the Octaweb kernel.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md149"></a>
Host API</h3>
<p>To integrate Depth of Field into your project, include the following header files:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;PostFXContext.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d9/dde/DepthOfField_8hpp.html">DepthOfField.hpp</a>&quot;</span></div>
<div class="ttc" id="aDepthOfField_8hpp_html"><div class="ttname"><a href="../../d9/dde/DepthOfField_8hpp.html">DepthOfField.hpp</a></div></div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">namespace </span>HLSL</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#include &quot;Shaders/Common/public/BasicStructures.fxh&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Shaders/PostProcess/DepthOfField/public/DepthOfFieldStructures.fxh&quot;</span></div>
<div class="line">} <span class="comment">// namespace HLSL</span></div>
</div><!-- fragment --><p>Next, create the necessary objects:</p>
<div class="fragment"><div class="line">m_PostFXContext = std::make_unique&lt;PostFXContext&gt;(m_pDevice);</div>
<div class="line">m_DOF           = std::make_unique&lt;DepthOfField&gt;(m_pDevice);</div>
</div><!-- fragment --><p>Next, call the methods to prepare resources for the <code>PostFXContext</code> and <code>DepthOfField</code> objects. This needs to be done every frame before starting the rendering process.</p>
<div class="fragment"><div class="line">PostFXContext::FrameDesc FrameDesc;</div>
<div class="line">FrameDesc.Index  = m_CurrentFrameNumber; <span class="comment">// Current frame number.</span></div>
<div class="line">FrameDesc.Width  = SCDesc.Width;         <span class="comment">// Current screen width.</span></div>
<div class="line">FrameDesc.Height = SCDesc.Height;        <span class="comment">// Current screen height.</span></div>
<div class="line">m_PostFXContext-&gt;PrepareResources(m_pDevice, FrameDesc, PostFXContext::FEATURE_FLAG_NONE);</div>
<div class="line"> </div>
<div class="line">m_DepthOfField-&gt;PrepareResources(m_pDevice, m_pImmediateContext, m_PostFXContext.get(), DepthOfField::FEATURE_FLAG_NONE);</div>
</div><!-- fragment --><p>Call the method <code>PostFXContext::Execute</code> to prepare intermediate resources necessary for all post-processing objects dependent on <code>PostFXContext</code>. This method can take a constant buffer containing the current and previous-frame cameras (refer to this code [<a href="https://github.com/DiligentGraphics/DiligentSamples/raw/380b0a05b6c72d80fd6d574d7343ead77d6dd7eb/Tutorials/Tutorial27_PostProcessing/src/Tutorial27_PostProcessing.cpp#L164">0</a>] and [<a href="https://github.com/DiligentGraphics/DiligentSamples/raw/380b0a05b6c72d80fd6d574d7343ead77d6dd7eb/Tutorials/Tutorial27_PostProcessing/src/Tutorial27_PostProcessing.cpp#L228">1</a>]). Alternatively, you can pass the corresponding pointers <code>const HLSL::CameraAttribs* pCurrCamera</code> and <code>const HLSL::CameraAttribs* pPrevCamera</code> for the current and previous cameras, respectively. You also need to pass the depth of the current and previous frames, and a buffer with motion vectors in NDC space, via the corresponding <code>ITextureView* pCurrDepthBufferSRV</code>, <code>ITextureView* pPrevDepthBufferSRV</code>, and <code>ITextureView* pMotionVectorsSRV</code> parameters.</p>
<div class="fragment"><div class="line">PostFXContext::RenderAttributes PostFXAttibs;</div>
<div class="line">PostFXAttibs.pDevice             = m_pDevice;</div>
<div class="line">PostFXAttibs.pDeviceContext      = m_pImmediateContext;</div>
<div class="line">PostFXAttibs.pCameraAttribsCB    = m_FrameAttribsCB;</div>
<div class="line">PostFXAttibs.pCurrDepthBufferSRV = m_CurrDepthBuffer;</div>
<div class="line">PostFXAttibs.pPrevDepthBufferSRV = m_PrevDepthBuffer;</div>
<div class="line">PostFXAttibs.pMotionVectorsSRV   = m_MotionBuffer;</div>
<div class="line">m_PostFXContext-&gt;Execute(PostFXAttibs);</div>
</div><!-- fragment --><p>To compute the depth of field effect, call the <code>DepthOfField::Execute</code> method. Before this, fill the <code>DepthOfFieldAttribs</code> and <code>DepthOfField::RenderAttributes</code> structures with the necessary data. Refer to the Input resources section for parameter description.</p>
<div class="fragment"><div class="line">HLSL::DepthOfFieldAttribs DOFSettings{};</div>
<div class="line"> </div>
<div class="line">DepthOfField::RenderAttributes DOFRenderAttribs{};</div>
<div class="line">DOFRenderAttribs.pDevice         = m_pDevice;</div>
<div class="line">DOFRenderAttribs.pDeviceContext  = m_pImmediateContext;</div>
<div class="line">DOFRenderAttribs.pPostFXContext  = m_PostFXContext.get();</div>
<div class="line">DOFRenderAttribs.pColorBufferSRV = m_ColorBuffer;</div>
<div class="line">DOFRenderAttribs.pDepthBufferSRv = m_CurrDepthBuffer;</div>
<div class="line">DOFRenderAttribs.pDOFAttribs     = &amp;DOFSettings;</div>
<div class="line">m_DOF-&gt;Execute(SSAORenderAttribs);</div>
</div><!-- fragment --><p>An <code>ITextureView</code> of the texture containing the depth of field result can be obtained using the <code>DepthOfField::GetDepthOfFieldTextureSRV</code> method.</p>
<h2><a class="anchor" id="autotoc_md150"></a>
Implementation details</h2>
<p>Our algorithm is based on the approach described in <b>[Jasper Flick, 2018]</b>, but we have significantly modified our version. Specifically, we handle the blurring of the near and far planes separately. For the near plane, we calculate the dilation and blurring of the CoC before computing the bokeh. This step is essential to avoid bleed effects. We also added an approach to eliminate the undersampling effect from <b>[Tiago Sousa, 2013]</b>.</p>
<h2><a class="anchor" id="autotoc_md151"></a>
References</h2>
<ul>
<li><b>[Jasper Flick, 2018]</b>: Advanced rendering: Depth of Field - <a href="https://catlikecoding.com/unity/tutorials/advanced-rendering/depth-of-field/">https://catlikecoding.com/unity/tutorials/advanced-rendering/depth-of-field/</a></li>
<li><b>[Steve Avery, 2016]</b>: Bokeh Depth of Field - <a href="https://pixelmischiefblog.wordpress.com/2016/11/25/bokeh-depth-of-field/">https://pixelmischiefblog.wordpress.com/2016/11/25/bokeh-depth-of-field/</a></li>
<li><b>[Matt Pettineo, 2011]</b>: How To Fake Bokeh (And Make It Look Pretty Good) <a href="https://therealmjp.github.io/posts/bokeh/">https://therealmjp.github.io/posts/bokeh/</a></li>
<li><b>[Tiago Sousa, 2013]</b>: Graphics Gems from CryENGINE 3 <a href="https://www.slideshare.net/TiagoAlexSousa/graphics-gems-from-cryengine-3-siggraph-2013">https://www.slideshare.net/TiagoAlexSousa/graphics-gems-from-cryengine-3-siggraph-2013</a></li>
<li><b>[Jeff Conrad, 2004]</b>: Depth of Field in Depth <a href="https://www.largeformatphotography.info/articles/DoFinDepth.pdf">https://www.largeformatphotography.info/articles/DoFinDepth.pdf</a></li>
<li><b>[Michael Bemowski]</b>: Depth of Field simulator <a href="https://dofsimulator.net/en/">https://dofsimulator.net/en/</a></li>
<li><b>[Adrian Courrèges]</b>: UE4 Optimized Post-Effects <a href="https://www.adriancourreges.com/blog/2018/12/02/ue4-optimized-post-effects/#ue4_dynres">https://www.adriancourreges.com/blog/2018/12/02/ue4-optimized-post-effects/#ue4_dynres</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <a href="https://diligentgraphics.com">
        <img class="footer" src="https://github.com/DiligentGraphics/DiligentCore/raw/master/media/diligentgraphics-logo.png" width="99" height="32" alt="Diligent Graphics" />
      </a>
    </li>
  </ul>
</div>
</body>
</html>
