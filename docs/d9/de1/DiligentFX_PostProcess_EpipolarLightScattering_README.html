<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diligent Engine: EpipolarLightScattering</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Diligent Engine
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d9/de1/DiligentFX_PostProcess_EpipolarLightScattering_README.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">EpipolarLightScattering</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="https://github.com/DiligentGraphics/DiligentFX/raw/master/PostProcess/EpipolarLightScattering/media/LightScattering.png" alt="" class="inline"/></p>
<p>This post-processing effect renders realistic high-quality light scattering effects and is based on this <a href="https://github.com/GameTechDev/OutdoorLightScattering">sample from Intel</a>. The effect works by smartly placing expensive ray-marching samples along the epipolar lines that start at the light source and interpolating the radiance between these samples.</p>
<p><img src="https://github.com/DiligentGraphics/DiligentFX/raw/master/PostProcess/EpipolarLightScattering/media/EpipolarSampling.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md155"></a>
Parameters</h2>
<p><code>EpipolarLightScatteringAttribs</code> structure The following parameters control the effect</p>
<ul>
<li><code>uiNumEpipolarSlices</code> - the total number of epipolar slices (lines). For high quality effect, set this value to (Screen Width + Screen Height)/2</li>
<li><code>uiMaxSamplesInSlice</code> - Maximum number of samples on a single epipolar line. When epipolar light is short, the actual number of samples may be lower. For high quality effect, set this value to max(Screen Width, Screen Height)/2.</li>
<li><code>uiInitialSampleStepInSlice</code> - Initial ray marching sample spacing on an epipolar line. Additional samples are added at discontinuities.</li>
<li><code>uiEpipoleSamplingDensityFactor</code> - Sample density scale near the epipole where inscattering changes rapidly. Note that sampling near the epipole is very cheap since only a few steps required to perform ray marching.</li>
<li><code>fRefinementThreshold</code> - Sampling refinement threshold that controls detection of discontinuities. Smaller values produce more samples and higher quality, but at a higher performance cost.</li>
<li><code>bShowSampling</code> - Whether to show epipolar sampling.</li>
<li><code>bCorrectScatteringAtDepthBreaks</code> - Whether to correct inscattering at depth discontinuities. Improves quality for additional cost. It may be preferable to increase the number of slices and or maximum number of samples on an epipolar line instead.</li>
<li><code>bShowDepthBreaks</code> - Whether to display pixels which are classified as depth discontinuities and which will be corrected. Only has effect when bCorrectScatteringAtDepthBreaks is TRUE.</li>
<li><code>bShowLightingOnly</code> - Whether to show lighting only</li>
<li><code>bOptimizeSampleLocations</code> - Optimize sample locations to avoid oversampling. This should generally be TRUE.</li>
<li><code>bEnableLightShafts</code> - Whether to enable light shafts or render unshadowed inscattering. Setting this to FALSE increases performance, but reduces visual quality.</li>
<li><code>uiInstrIntegralSteps</code> - Number of inscattering integral steps taken when computing unshadowed inscattering Default value is OK and should not be changed.</li>
<li><code>f2ShadowMapTexelSize</code> - Size of the shadowmap texel (1/width, 1/height)</li>
<li><code>uiMaxSamplesOnTheRay</code> - Maximum number of ray marching samples on a single ray. Typically this value should match the maximum shadow map cascade resolution. Using lower value will improve performance but may result in moire patterns. Note that in most cases significantly less samples are actually taken.</li>
<li><code>uiMinMaxShadowMapResolution</code> - Defines the number of samples at the lowest level of min-max binary tree and should match the maximum cascade shadow map resolution.</li>
<li><code>iNumCascades</code> - Number of shadow map cascades</li>
<li><code>iFirstCascadeToRayMarch</code> - First cascade to use for ray marching. Usually first few cascades are small, and ray marching them is inefficient.</li>
<li><code>fMaxShadowMapStep</code> - Cap on the maximum shadow map step in texels.</li>
<li><code>bUse1DMinMaxTree</code> - Whether to use 1D min/max binary tree optimization. This improves performance for higher shadow map resolution. Test it.</li>
<li><code>bIs32BitMinMaxMipMap</code> - Whether to use 32-bit float or 16-bit UNORM min-max binary tree. Usually 16-bit UNORM is OK.</li>
<li><code>uiLightSctrTechnique</code> - Light scattering evaluation technique. The following two methods are available: epipolar and brute-force. Brute force light scattering performs expensive ray marching for every screen pixel. This method can be used as the quality reference.</li>
<li><code>uiCascadeProcessingMode</code> - Shadow map cascades processing mode.</li>
<li><code>uiRefinementCriterion</code> - Epipolar sampling refinement criterion. The two options are depth difference and scattering difference. Scattering difference is generally preferable way.</li>
<li><code>uiSingleScatteringMode</code> - Single scattering evaluation mode. The following three methods are available:<ul>
<li>None - no single scattering.</li>
<li>Integration (default) - evaluate single scattering with numerical integration.</li>
<li>Look-up table - use precomputed single-scattering look-up table.</li>
</ul>
</li>
<li><code>uiMultipleScatteringMode</code> - Higher-order scattering evaluation mode. The following three options are available:<ul>
<li>None - no multiple scattering.</li>
<li>Unoccluded (default) - evaluate multiple scattering without shadowing.</li>
<li>Occluded - evaluate multiple scattering taking shadowing into account similar to single scattering.</li>
</ul>
</li>
<li><code>uiExtinctionEvalMode</code> - Atmospheric extinction evaluation mode.</li>
<li><code>bUseCustomSctrCoeffs</code> - Whether to use custom scattering coefficients.</li>
<li><code>fAerosolDensityScale</code> - Aerosol density scale to use for scattering coefficient computation.</li>
<li><code>fAerosolAbsorbtionScale</code> - Aerosol absorption scale to use for scattering coefficient computation.</li>
<li><code>f4CustomRlghBeta</code> - Custom Rayleigh coefficients.</li>
<li><code>f4CustomMieBeta</code> - Custom Mie coefficients.</li>
</ul>
<h2><a class="anchor" id="autotoc_md156"></a>
Integration</h2>
<p>The effect requires the following data:</p><ul>
<li>Shader and render target views of the original color buffer</li>
<li>Shader and depth-stencil views of the original depth buffer</li>
<li>Shadow map</li>
<li>Light and color attributes</li>
</ul>
<p>The code snippet below shows how to use the epipolar light scattering post-processing effect. For the full source code, see <a href="https://github.com/DiligentGraphics/DiligentSamples/tree/master/Samples/Atmosphere">Atmospheric scattering sample</a>.</p>
<div class="fragment"><div class="line">EpipolarLightScattering::FrameAttribs FrameAttribs;</div>
<div class="line"> </div>
<div class="line">FrameAttribs.pDevice        = m_pDevice;</div>
<div class="line">FrameAttribs.pDeviceContext = m_pImmediateContext;</div>
<div class="line">FrameAttribs.dElapsedTime   = m_fElapsedTime;</div>
<div class="line">FrameAttribs.pLightAttribs  = &amp;LightAttrs;</div>
<div class="line">FrameAttribs.pCameraAttribs = &amp;CamAttribs;</div>
<div class="line"> </div>
<div class="line">m_PPAttribs.iNumCascades = m_TerrainRenderParams.m_iNumShadowCascades;</div>
<div class="line">m_PPAttribs.fNumCascades = (float)m_TerrainRenderParams.m_iNumShadowCascades;</div>
<div class="line"> </div>
<div class="line">FrameAttribs.pcbLightAttribs  = m_pcbLightAttribs;</div>
<div class="line">FrameAttribs.pcbCameraAttribs = m_pcbCameraAttribs;</div>
<div class="line"> </div>
<div class="line">m_PPAttribs.fMaxShadowMapStep = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(m_uiShadowMapResolution / 4);</div>
<div class="line">        </div>
<div class="line">m_PPAttribs.f2ShadowMapTexelSize = float2( 1.f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(m_uiShadowMapResolution), 1.f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(m_uiShadowMapResolution) );</div>
<div class="line">m_PPAttribs.uiMaxSamplesOnTheRay = m_uiShadowMapResolution;</div>
<div class="line"><span class="comment">// During the ray marching, on each step we move by the texel size in either horz </span></div>
<div class="line"><span class="comment">// or vert direction. So resolution of min/max mipmap should be the same as the </span></div>
<div class="line"><span class="comment">// resolution of the original shadow map</span></div>
<div class="line">m_PPAttribs.uiMinMaxShadowMapResolution    = m_uiShadowMapResolution;</div>
<div class="line">m_PPAttribs.uiInitialSampleStepInSlice     = std::min( m_PPAttribs.uiInitialSampleStepInSlice, m_PPAttribs.uiMaxSamplesInSlice );</div>
<div class="line">m_PPAttribs.uiEpipoleSamplingDensityFactor = std::min( m_PPAttribs.uiEpipoleSamplingDensityFactor, m_PPAttribs.uiInitialSampleStepInSlice );</div>
<div class="line"> </div>
<div class="line">FrameAttribs.ptex2DSrcColorBufferSRV = m_pOffscreenColorBuffer-&gt;GetDefaultView(TEXTURE_VIEW_SHADER_RESOURCE);</div>
<div class="line">FrameAttribs.ptex2DSrcColorBufferRTV = m_pOffscreenColorBuffer-&gt;GetDefaultView(TEXTURE_VIEW_RENDER_TARGET);</div>
<div class="line">FrameAttribs.ptex2DSrcDepthBufferSRV = m_pOffscreenDepthBuffer-&gt;GetDefaultView(TEXTURE_VIEW_SHADER_RESOURCE);</div>
<div class="line">FrameAttribs.ptex2DSrcDepthBufferDSV = m_pOffscreenDepthBuffer-&gt;GetDefaultView(TEXTURE_VIEW_DEPTH_STENCIL);</div>
<div class="line">FrameAttribs.ptex2DShadowMapSRV      = m_pShadowMapSRV;</div>
<div class="line">FrameAttribs.pDstRTV                 = <span class="keyword">nullptr</span>;<span class="comment">// mpBackBufferRTV;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Perform the post processing</span></div>
<div class="line">m_pLightSctrPP-&gt;PerformPostProcessing(FrameAttribs, m_PPAttribs);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <a href="https://diligentgraphics.com">
        <img class="footer" src="https://github.com/DiligentGraphics/DiligentCore/raw/master/media/diligentgraphics-logo.png" width="99" height="32" alt="Diligent Graphics" />
      </a>
    </li>
  </ul>
</div>
</body>
</html>
