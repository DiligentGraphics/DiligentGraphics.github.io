<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diligent Engine: Rendering Components</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Diligent Engine
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('de/d22/DiligentFX_Components_README.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Rendering Components</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Rendering components are designed to be plug-and-play blocks of functionaliy that can be used by applications.</p>
<h2><a class="anchor" id="autotoc_md111"></a>
Shadows</h2>
<p><img src="https://github.com/DiligentGraphics/DiligentFX/raw/master/Components/media/Powerplant-Shadows.jpg" alt="" class="inline"/></p>
<p>The shadowing component implements the following BKMs:</p>
<ul>
<li>Cascaded shadow maps with cascade stabilization</li>
<li>PCF</li>
<li>Variance shadow maps</li>
<li>Two and four-component exponential variance shadow maps</li>
<li>Optimized fixed-size or world-sized filter kernels</li>
<li>Best cascade search based on projection into light space</li>
<li>Filtering across cascades</li>
<li>Various artifact removal techniques</li>
</ul>
<h3><a class="anchor" id="autotoc_md112"></a>
Integrating shadows into application</h3>
<p>The component is implemented by the following source files:</p>
<ul>
<li><a href="../../interface/ShadowMapManager.h">ShadowMapManager.h</a>/<a href="../../src/ShadowMapManager.cpp">ShadowMapManager.cpp</a> - implementation of the shadow map manager.</li>
<li><a href="../../../Shaders/Common/public/Shadows.fxh">Shadows.fxh</a> - shader functionality.</li>
</ul>
<h4><a class="anchor" id="autotoc_md113"></a>
Initialization</h4>
<p>The shadow map manager is responsible for creating required textures and views, cascade partitioning, converting shadow map to filterable representations (VSM/EVSM) etc.</p>
<p>To initialize the manager, prepare <code>ShadowMapManager::InitInfo</code> structure that defines initialization parameters and call <code>ShadowMapManager::Initialize</code>, for example:</p>
<div class="fragment"><div class="line">ShadowMapManager::InitInfo SMMgrInitInfo;</div>
<div class="line">SMMgrInitInfo.Format               = TEX_FORMAT_D16_UNORM;</div>
<div class="line">SMMgrInitInfo.Resolution           = 1024;</div>
<div class="line">SMMgrInitInfo.NumCascades          = 4;</div>
<div class="line">SMMgrInitInfo.ShadowMode           = SHADOW_MODE_PCF;</div>
<div class="line">SMMgrInitInfo.pComparisonSampler   = m_pComparisonSampler;</div>
<div class="line">m_ShadowMapMgr.Initialize(m_pDevice, SMMgrInitInfo);</div>
</div><!-- fragment --><p>Most of the fields of <code>ShadowMapManager::InitInfo</code> structure are self-explanatory. <code>pComparisonSampler</code> defines optional texture sampler to be set in the shadow map resource view. If the sampler is <code>null</code>, the application is responsible for setting appropriate sampler before using the shadow map in the shader.</p>
<h4><a class="anchor" id="autotoc_md114"></a>
Cascade Partitioning</h4>
<p>To distribute shadow map cascades, populate <code>ShadowMapManager::DistributeCascadeInfo</code> that defines partitioning parameters and call <code>ShadowMapManager::DistributeCascades</code>:</p>
<div class="fragment"><div class="line">ShadowMapManager::DistributeCascadeInfo DistrInfo;</div>
<div class="line">DistrInfo.pCameraView         = &amp;m_Camera.GetViewMatrix();</div>
<div class="line">DistrInfo.pCameraProj         = &amp;m_Camera.GetProjMatrix();</div>
<div class="line">DistrInfo.pLightDir           = &amp;m_f3LightDirection;</div>
<div class="line">DistrInfo.fPartitioningFactor = 0.95f;</div>
<div class="line">m_ShadowMapMgr.DistributeCascades(DistrInfo, m_LightAttribs.ShadowAttribs);</div>
</div><!-- fragment --><p><code>fPartitioningFactor</code> member defines the ratio between fully linear (0.0) and fully logarithmic (1.0) partitioning. The method populates the <code>ShadowMapAttribs</code> structure that is part of the <code>LightAttribs</code> structure and should be made available to a shader via constant buffer.</p>
<h4><a class="anchor" id="autotoc_md115"></a>
Rendering Shadow Cascades</h4>
<p>After cascades are distributed, use <code>ShadowMapManager::GetCascadeTranform</code> method to access transform matrices and render every cascade:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> iNumShadowCascades = m_LightAttribs.ShadowAttribs.iNumCascades;</div>
<div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">int</span> iCascade = 0; iCascade &lt; iNumShadowCascades; ++iCascade)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> CascadeProjMatr = m_ShadowMapMgr.GetCascadeTranform(iCascade).Proj;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> WorldToLightViewSpaceMatr = m_LightAttribs.ShadowAttribs.mWorldToLightViewT.Transpose();</div>
<div class="line">    <span class="keyword">auto</span> WorldToLightProjSpaceMatr = WorldToLightViewSpaceMatr * CascadeProjMatr;</div>
<div class="line">    CameraAttribs ShadowCameraAttribs = {};</div>
<div class="line">    ShadowCameraAttribs.mViewT     = m_LightAttribs.ShadowAttribs.mWorldToLightViewT;</div>
<div class="line">    ShadowCameraAttribs.mProjT     = CascadeProjMatr.Transpose();</div>
<div class="line">    ShadowCameraAttribs.mViewProjT = WorldToLightProjSpaceMatr.Transpose();</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">        MapHelper&lt;CameraAttribs&gt; CameraData(m_pImmediateContext, m_CameraAttribsCB, MAP_WRITE, MAP_FLAG_DISCARD);</div>
<div class="line">        *CameraData = ShadowCameraAttribs;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>* pCascadeDSV = m_ShadowMapMgr.GetCascadeDSV(iCascade);</div>
<div class="line">    m_pImmediateContext-&gt;SetRenderTargets(0, <span class="keyword">nullptr</span>, pCascadeDSV,</div>
<div class="line">                                          RESOURCE_STATE_TRANSITION_MODE_TRANSITION);</div>
<div class="line">    m_pImmediateContext-&gt;ClearDepthStencil(pCascadeDSV, CLEAR_DEPTH_FLAG, 1.f, 0,</div>
<div class="line">                                           RESOURCE_STATE_TRANSITION_MODE_TRANSITION);</div>
<div class="line"> </div>
<div class="line">    DrawMesh(m_pImmediateContext);</div>
<div class="line">}</div>
</div><!-- fragment --><p>When using filterable representations, the shadow map must be post-processed before it can be used in a shader:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (m_ShadowSettings.iShadowMode &gt; SHADOW_MODE_PCF)</div>
<div class="line">    m_ShadowMapMgr.ConvertToFilterable(m_pImmediateContext, m_LightAttribs.ShadowAttribs);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md116"></a>
Rendering with Shadows</h4>
<p>To use shadowing functionality in the shader, include <code>BasicStructures.fxh</code> and <code>Shadows.fxh</code> files and depending on the shadowing mode, define shadow map or filterable shadow map textures and corresponding samplers (note that the names must be different to allow HLSL to GLSL conversion):</p>
<div class="fragment"><div class="line">#include &quot;BasicStructures.fxh&quot;</div>
<div class="line">#include &quot;Shadows.fxh&quot;</div>
<div class="line"> </div>
<div class="line">#if SHADOW_MODE == SHADOW_MODE_PCF</div>
<div class="line">    Texture2DArray&lt;float&gt;  g_tex2DShadowMap;</div>
<div class="line">    SamplerComparisonState g_tex2DShadowMap_sampler;</div>
<div class="line">#else</div>
<div class="line">    Texture2DArray&lt;float4&gt; g_tex2DFilterableShadowMap;</div>
<div class="line">    SamplerState           g_tex2DFilterableShadowMap_sampler;</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>To filter shadow map, call <code>FilterShadowMap</code> or <code>SampleFilterableShadowMap</code> function:</p>
<div class="fragment"><div class="line">FilteredShadow Shadow;</div>
<div class="line">#if SHADOW_MODE == SHADOW_MODE_PCF</div>
<div class="line">    Shadow = FilterShadowMap(g_LightAttribs.ShadowAttribs, g_tex2DShadowMap, g_tex2DShadowMap_sampler,</div>
<div class="line">                             VSOut.PosInLightViewSpace, VSOut.CameraSpaceZ);</div>
<div class="line">#else</div>
<div class="line">    Shadow = SampleFilterableShadowMap(g_LightAttribs.ShadowAttribs, g_tex2DFilterableShadowMap,</div>
<div class="line">                                       g_tex2DFilterableShadowMap_sampler, VSOut.PosInLightViewSpace,</div>
<div class="line">                                       VSOut.CameraSpaceZ);</div>
<div class="line">#endif</div>
<div class="line">DiffuseIllumination *= Shadow.fLightAmount;</div>
</div><!-- fragment --><p>Shadow filtering mode is controlled by a number of macros that should be defined when creating the shader:</p>
<div class="fragment"><div class="line">ShaderCreateInfo ShaderCI;</div>
<div class="line">ShaderMacroHelper Macros;</div>
<div class="line">Macros.AddShaderMacro( <span class="stringliteral">&quot;SHADOW_MODE&quot;</span>,            m_ShadowSettings.iShadowMode);</div>
<div class="line">Macros.AddShaderMacro( <span class="stringliteral">&quot;SHADOW_FILTER_SIZE&quot;</span>,     m_LightAttribs.ShadowAttribs.iFixedFilterSize);</div>
<div class="line">Macros.AddShaderMacro( <span class="stringliteral">&quot;FILTER_ACROSS_CASCADES&quot;</span>, m_ShadowSettings.FilterAcrossCascades);</div>
<div class="line">Macros.AddShaderMacro( <span class="stringliteral">&quot;BEST_CASCADE_SEARCH&quot;</span>,    m_ShadowSettings.SearchBestCascade );</div>
<div class="line">ShaderCI.<a class="code hl_variable" href="../../dd/d3d/structDiligent_1_1ShaderCreateInfo.html#a1f673ef744b8403a9db100be996aae7d">Macros</a> = Macros;</div>
<div class="ttc" id="astructDiligent_1_1ShaderCreateInfo_html_a1f673ef744b8403a9db100be996aae7d"><div class="ttname"><a href="../../dd/d3d/structDiligent_1_1ShaderCreateInfo.html#a1f673ef744b8403a9db100be996aae7d">Diligent::ShaderCreateInfo::Macros</a></div><div class="ttdeci">ShaderMacroArray Macros</div><div class="ttdoc">Shader macros (see Diligent::ShaderMacroArray)</div><div class="ttdef"><b>Definition</b> Shader.h:480</div></div>
</div><!-- fragment --><p><a href="https://github.com/DiligentGraphics/DiligentSamples/tree/master/Samples/Shadows">Shadows sample</a> gives an example of using the shadowing component.</p>
<h3><a class="anchor" id="autotoc_md117"></a>
References</h3>
<ul>
<li><a href="http://www.punkuser.net/vsm/">Variance Shadow Maps</a></li>
<li><a href="http://www.punkuser.net/lvsm/lvsm_web.pdf">Layered variance shadow maps</a></li>
<li><a href="https://mynameismjp.wordpress.com/2015/02/18/shadow-sample-update/">Shadow sample update by MJP</a></li>
<li><a href="https://github.com/TheRealMJP/Shadows">MJP's shadows sample source code</a></li>
<li><a href="https://software.intel.com/en-us/articles/shadow-explorer-sample">Shadow Explorer sample from Intel</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/dxtecharts/cascaded-shadow-maps">Cascaded Shadow Maps technical article by Microsoft</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <a href="https://diligentgraphics.com">
        <img class="footer" src="https://github.com/DiligentGraphics/DiligentCore/raw/master/media/diligentgraphics-logo.png" width="99" height="32" alt="Diligent Graphics" />
      </a>
    </li>
  </ul>
</div>
</body>
</html>
