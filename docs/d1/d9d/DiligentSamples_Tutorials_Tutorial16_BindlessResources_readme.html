<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diligent Engine: Tutorial16 - Bindless Resources</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Diligent Engine
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d9d/DiligentSamples_Tutorials_Tutorial16_BindlessResources_readme.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tutorial16 - Bindless Resources</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial shows how to implement bindless resources, a technique that leverages dynamic shader resource indexing feature enabled by the next-gen APIs to significantly improve rendering performance.</p>
<p><img src="https://github.com/DiligentGraphics/DiligentSamples/raw/master/Tutorials/Tutorial16_BindlessResources/Animation_Large.gif" alt="" class="inline"/></p>
<p><a href="https://diligentgraphics.github.io/wasm-modules/Tutorial16_BindlessResources/Tutorial16_BindlessResources.html">â–¶ Run in the browser</a></p>
<p>In old APIs (Direct3D11, OpenGL/GLES), when an application needed to render multiple objects using different shader resources, it had to run the following loop:</p>
<ol type="1">
<li>Bind required resources (textures, constant buffers, etc.)</li>
<li>Issue draw commands</li>
<li>Go to step 1 and repeat operations for the next object.</li>
</ol>
<p>There are multiple rechinques to make this loop more efficient such as instancing (see <a href="https://github.com/DiligentGraphics/DiligentSamples/tree/master/Tutorials/Tutorial04_Instancing">Tutorial 4</a>), texture arrays (see <a href="https://github.com/DiligentGraphics/DiligentSamples/tree/master/Tutorials/Tutorial05_TextureArray">Tutorial 5</a>), etc. All these methods, however, are very limited.</p>
<p>Next-generation APIs (Direct3D12, Vulkan, Metal) enable a more efficient way: instead of binding new resources every time next object is rendered, all required resources can be bound once, while shaders can dynamically access required resources using the draw call information.</p>
<h2><a class="anchor" id="autotoc_md376"></a>
Shaders</h2>
<p>This tutorial is based on <a href="https://github.com/DiligentGraphics/DiligentSamples/tree/master/Tutorials/Tutorial05_TextureArray">Tutorial 5</a>. However, while original tutorial used a texture array object that required all array slices to be identical (same size, format, number of mip levels, etc.), this tutorial binds textures as an array of shader resources. Unlike texture array object, all resources in an array of resources may have completely different parameters. The pixel shader is able to dynamically select the texture to sample using the texture index it receives from the vertex shader (that reads it from the instance data buffer):</p>
<div class="fragment"><div class="line">#define NUM_TEXTURES 4</div>
<div class="line">Texture2D     g_Texture[NUM_TEXTURES];</div>
<div class="line">SamplerState  g_Texture_sampler;</div>
<div class="line"> </div>
<div class="line">struct PSInput </div>
<div class="line">{ </div>
<div class="line">    float4 Pos      : SV_POSITION; </div>
<div class="line">    float2 UV       : TEX_COORD; </div>
<div class="line">    uint   TexIndex : TEX_ARRAY_INDEX;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">struct PSOutput</div>
<div class="line">{</div>
<div class="line">    float4 Color : SV_TARGET;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">void main(in  PSInput  PSIn,</div>
<div class="line">          out PSOutput PSOut)</div>
<div class="line">{</div>
<div class="line">    PSOut.Color = g_Texture[NonUniformResourceIndex(PSIn.TexIndex)].Sample(g_Texture_sampler, PSIn.UV);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Notice the <code>NonUniformResourceIndex</code> pseudo-function. It tells the shader compiler that the texture index is not uniform, e.g. it may be different in every pixel. <a href="https://www.asawicki.info/news_1608_direct3d_12_-_watch_out_for_non-uniform_resource_index">Using it is essential</a>, or the shader may behave incorrectly.</p>
<h2><a class="anchor" id="autotoc_md377"></a>
Pipeline State and Shader Resource Binding</h2>
<p>There are no differences in pipeline state initialization for bindless shaders. Shader resource binding objects are also initialized the same way, with the only difference that we bind an array of objects using <code>SetArray</code> method:</p>
<div class="fragment"><div class="line">m_pBindlessPSO-&gt;CreateShaderResourceBinding(&amp;m_BindlessSRB, <span class="keyword">true</span>);</div>
<div class="line">m_BindlessSRB-&gt;GetVariableByName(SHADER_TYPE_PIXEL, <span class="stringliteral">&quot;g_Texture&quot;</span>)-&gt;SetArray(pTexSRVs, 0, NumTextures);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md378"></a>
Rendering</h2>
<p>As we discussed earlier, to render all objects, we bind all resources once:</p>
<div class="fragment"><div class="line">m_pImmediateContext-&gt;SetPipelineState(m_pBindlessPSO);</div>
<div class="line">m_pImmediateContext-&gt;CommitShaderResources(m_BindlessSRB, RESOURCE_STATE_TRANSITION_MODE_VERIFY);</div>
</div><!-- fragment --><p>And then render each object using its geometry properties. Texture index will be fetched from the instance data buffer and passed over to the pixel shader.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; NumObjects; ++i)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> ObjectGeometry&amp; Geometry = m_Geometries[m_GeometryType[i]];</div>
<div class="line"> </div>
<div class="line">    DrawIndexedAttribs DrawAttrs;</div>
<div class="line">    DrawAttrs.<a class="code hl_variable" href="../../d2/dce/structDiligent_1_1DrawIndexedAttribs.html#ac726f684a259d8f04d5136a7499843ba">IndexType</a>             = VT_UINT32;</div>
<div class="line">    DrawAttrs.NumIndices            = Geometry.NumIndices;</div>
<div class="line">    DrawAttrs.FirstIndexLocation    = Geometry.FirstIndex;</div>
<div class="line">    DrawAttrs.FirstInstanceLocation = <span class="keyword">static_cast&lt;</span>Uint32<span class="keyword">&gt;</span>(i);</div>
<div class="line">    DrawAttrs.Flags = DRAW_FLAG_VERIFY_ALL | DRAW_FLAG_DYNAMIC_RESOURCE_BUFFERS_INTACT;</div>
<div class="line">    m_pImmediateContext-&gt;DrawIndexed(DrawAttrs);</div>
<div class="line">}</div>
<div class="ttc" id="astructDiligent_1_1DrawIndexedAttribs_html_ac726f684a259d8f04d5136a7499843ba"><div class="ttname"><a href="../../d2/dce/structDiligent_1_1DrawIndexedAttribs.html#ac726f684a259d8f04d5136a7499843ba">Diligent::DrawIndexedAttribs::IndexType</a></div><div class="ttdeci">VALUE_TYPE IndexType</div><div class="ttdoc">The type of elements in the index buffer.</div><div class="ttdef"><b>Definition</b> DeviceContext.h:323</div></div>
</div><!-- fragment --><p>Notice that we use <code>DRAW_FLAG_DYNAMIC_RESOURCE_BUFFERS_INTACT</code> flag. This flag informs the engine that none of the dynamic buffers have been modified since the last draw command, which saves extra work the engine would have to perform otherwise. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <a href="https://diligentgraphics.com">
        <img class="footer" src="https://github.com/DiligentGraphics/DiligentCore/raw/master/media/diligentgraphics-logo.png" width="99" height="32" alt="Diligent Graphics" />
      </a>
    </li>
  </ul>
</div>
</body>
</html>
