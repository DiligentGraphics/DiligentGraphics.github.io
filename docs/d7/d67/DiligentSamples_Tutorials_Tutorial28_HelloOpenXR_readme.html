<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diligent Engine: Tutorial28 - Hello OpenXR</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Diligent Engine
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d7/d67/DiligentSamples_Tutorials_Tutorial28_HelloOpenXR_readme.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tutorial28 - Hello OpenXR</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial demonstrates how to use <a class="el" href="../../d7/dca/namespaceDiligent.html" title="Graphics engine namespace.">Diligent</a> Engine with OpenXR API to render a simple scene in a VR headset.</p>
<h2><a class="anchor" id="autotoc_md465"></a>
Prerequisites</h2>
<p>This tutorial is based on <a href="https://openxr-tutorial.com//android/vulkan/3-graphics.html">OpenXT Tutorial 03 by Khronos</a>. Please refer to the original tutorial for detailed explanation of all OpenXR-related steps. The rest of this document focuses on <a class="el" href="../../d7/dca/namespaceDiligent.html" title="Graphics engine namespace.">Diligent</a> Engine-specific steps and assumes that the reader is familiar with OpenXR API.</p>
<h2><a class="anchor" id="autotoc_md466"></a>
Diligent Engine Integration</h2>
<h3><a class="anchor" id="autotoc_md467"></a>
Initialization</h3>
<p>OpenXR instance should enable the following extensions:</p>
<ul>
<li><code>XR_KHR_D3D11_enable</code> for Direct3D11</li>
<li><code>XR_KHR_D3D12_enable</code> for Direct3D12</li>
<li><code>XR_KHR_opengl_enable</code> for OpenGL</li>
<li><code>XR_KHR_opengl_es_enable</code> for OpenGL ES</li>
<li><code>XR_KHR_vulkan_enable2</code> for Vulkan</li>
</ul>
<p><a class="el" href="../../d7/dca/namespaceDiligent.html" title="Graphics engine namespace.">Diligent</a> Engine should be initialized after the OpenXR instance is created and system id is obtained. Prepare the <code>OpenXRAttribs</code> structure:</p>
<div class="fragment"><div class="line">OpenXRAttribs XRAttribs;</div>
<div class="line">memcpy(&amp;XRAttribs.Instance, &amp;m_xrInstance, <span class="keyword">sizeof</span>(m_xrInstance));</div>
<div class="line">memcpy(&amp;XRAttribs.SystemId, &amp;m_xrSystemId, <span class="keyword">sizeof</span>(m_xrSystemId));</div>
<div class="line">XRAttribs.GetInstanceProcAddr = xrGetInstanceProcAddr;</div>
</div><!-- fragment --><p>Set the pointer to <code>OpenXRAttribs</code> structure in the engine creation info and create the device and immediate context as usual. For example:</p>
<div class="fragment"><div class="line">EngineVkCreateInfo EngineCI;</div>
<div class="line">EngineCI.<a class="code hl_variable" href="../../db/d27/structDiligent_1_1EngineCreateInfo.html#a49d1cc5e1c4957ec8d5b489c59e73848">pXRAttribs</a> = &amp;XRAttribs;</div>
<div class="line"> </div>
<div class="line">pFactoryVk-&gt;CreateDeviceAndContextsVk(EngineCI, &amp;pDevice, &amp;m_pImmediateContext);</div>
<div class="ttc" id="astructDiligent_1_1EngineCreateInfo_html_a49d1cc5e1c4957ec8d5b489c59e73848"><div class="ttname"><a href="../../db/d27/structDiligent_1_1EngineCreateInfo.html#a49d1cc5e1c4957ec8d5b489c59e73848">Diligent::EngineCreateInfo::pXRAttribs</a></div><div class="ttdeci">const OpenXRAttribs * pXRAttribs</div><div class="ttdef"><b>Definition</b> GraphicsTypes.h:3552</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md468"></a>
Creating OpenXR Session</h3>
<p>To obtain graphics binding required to create the session, use the <code>GetOpenXRGraphicsBinding</code> function defined in <code><a class="el" href="../../d9/d48/OpenXRUtilities_8h.html">OpenXRUtilities.h</a></code> (link with <code>Diligent-GraphicsTools</code>):</p>
<div class="fragment"><div class="line">RefCntAutoPtr&lt;IDataBlob&gt; pGraphicsBinding;</div>
<div class="line">GetOpenXRGraphicsBinding(m_Device, m_pImmediateContext, &amp;pGraphicsBinding);</div>
<div class="line"> </div>
<div class="line">XrSessionCreateInfo SessionCI{XR_TYPE_SESSION_CREATE_INFO};</div>
<div class="line">SessionCI.next        = pGraphicsBinding-&gt;GetConstDataPtr();</div>
<div class="line">SessionCI.createFlags = 0;</div>
<div class="line">SessionCI.systemId    = m_xrSystemId;</div>
<div class="line"> </div>
<div class="line">xrCreateSession(m_xrInstance, &amp;SessionCI, &amp;m_xrSession);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md469"></a>
Creating Swapchain</h3>
<p>To enumerate swapchain images, use the <code>AllocateOpenXRSwapchainImageData</code> function that allocates an array of appropriate structures for each device type (<code>XrSwapchainImageVulkanKHR</code>, <code>XrSwapchainImageD3D11KHR</code>, etc.):</p>
<div class="fragment"><div class="line"><span class="comment">// Get the number of images in the swapchain.</span></div>
<div class="line">uint32_t SwapchainImageCount = 0;</div>
<div class="line">xrEnumerateSwapchainImages(xrSwapchain, 0, &amp;SwapchainImageCount, <span class="keyword">nullptr</span>);</div>
<div class="line"><span class="comment">// Allocate the memory for the swapchain image data.</span></div>
<div class="line">RefCntAutoPtr&lt;IDataBlob&gt; pSwapchainImageData;</div>
<div class="line">AllocateOpenXRSwapchainImageData(m_DeviceType, SwapchainImageCount, &amp;pSwapchainImageData);</div>
<div class="line"><span class="comment">// Get the swapchain image data.</span></div>
<div class="line">xrEnumerateSwapchainImages(xrSwapchain, SwapchainImageCount, &amp;SwapchainImageCount,</div>
<div class="line">                           pSwapchainImageData-&gt;GetDataPtr&lt;XrSwapchainImageBaseHeader&gt;());</div>
</div><!-- fragment --><p>To create a texture corresponding to the swapchain image, use the <code>GetOpenXRSwapchainImage</code> function:</p>
<div class="fragment"><div class="line">std::string Name = <span class="stringliteral">&quot;Swapchain Image &quot;</span> + std::to_string(j);</div>
<div class="line">TextureDesc ImgDesc;</div>
<div class="line">ImgDesc.<a class="code hl_variable" href="../../d3/df9/structDiligent_1_1DeviceObjectAttribs.html#a14a31dc6ad69e0b79514e5349e9b4fc0">Name</a>      = Name.c_str();</div>
<div class="line">ImgDesc.Type      = RESOURCE_DIM_TEX_2D;</div>
<div class="line">ImgDesc.Format    = Format;</div>
<div class="line">ImgDesc.Width     = SwapchainCI.width;</div>
<div class="line">ImgDesc.Height    = SwapchainCI.height;</div>
<div class="line">ImgDesc.MipLevels = 1;</div>
<div class="line">ImgDesc.BindFlags = (IsDepth ? BIND_DEPTH_STENCIL : BIND_RENDER_TARGET) | BIND_SHADER_RESOURCE;</div>
<div class="line"> </div>
<div class="line">RefCntAutoPtr&lt;ITexture&gt; pImage;</div>
<div class="line">GetOpenXRSwapchainImage(m_Device, pSwapchainImageData-&gt;GetConstDataPtr&lt;XrSwapchainImageBaseHeader&gt;(), j, ImgDesc, &amp;pImage);</div>
<div class="ttc" id="astructDiligent_1_1DeviceObjectAttribs_html_a14a31dc6ad69e0b79514e5349e9b4fc0"><div class="ttname"><a href="../../d3/df9/structDiligent_1_1DeviceObjectAttribs.html#a14a31dc6ad69e0b79514e5349e9b4fc0">Diligent::DeviceObjectAttribs::Name</a></div><div class="ttdeci">const Char * Name</div><div class="ttdoc">Object name.</div><div class="ttdef"><b>Definition</b> GraphicsTypes.h:1319</div></div>
</div><!-- fragment --><p>Note that since Vulkan does not provide a way to query image properties, the <code>ImgDesc</code> structure must be filled manually.</p>
<p>Render target / depth stencil views can be created as usual:</p>
<div class="fragment"><div class="line">TextureViewDesc ViewDesc;</div>
<div class="line">ViewDesc.<a class="code hl_variable" href="../../dd/d9c/structDiligent_1_1TextureViewDesc.html#aff7202999e6f78d0f51e58ceb2e9e301">ViewType</a> = TEXTURE_VIEW_RENDER_TARGET;</div>
<div class="line">RefCntAutoPtr&lt;ITextureView&gt; pRTV;</div>
<div class="line">pImage-&gt;CreateView(ViewDesc, &amp;pRTV);</div>
<div class="ttc" id="astructDiligent_1_1TextureViewDesc_html_aff7202999e6f78d0f51e58ceb2e9e301"><div class="ttname"><a href="../../dd/d9c/structDiligent_1_1TextureViewDesc.html#aff7202999e6f78d0f51e58ceb2e9e301">Diligent::TextureViewDesc::ViewType</a></div><div class="ttdeci">TEXTURE_VIEW_TYPE ViewType</div><div class="ttdoc">Describes the texture view type, see Diligent::TEXTURE_VIEW_TYPE for details.</div><div class="ttdef"><b>Definition</b> TextureView.h:227</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md470"></a>
Rendering</h3>
<p>Render target and depth stencil views obtained from the swapchain images can be used as usual. Note that OpenXR spec guarantees that the swapchain images acquired by xrAcquireSwapchainImage are in COLOR_ATTACHMENT_OPTIMAL/DEPTH_STENCIL_ATTACHMENT_OPTIMAL state, so you may explicitly set these states at the beginning of the frame:</p>
<div class="fragment"><div class="line">pRTV-&gt;GetTexture()-&gt;SetState(RESOURCE_STATE_RENDER_TARGET);</div>
<div class="line">pDSV-&gt;GetTexture()-&gt;SetState(RESOURCE_STATE_DEPTH_WRITE);</div>
</div><!-- fragment --><p>At the end of the frame, it is important to recycle resources. Normally, this is done by the engine when the primiary swap chain is presented. Since we are rendering to OpenXR swapchains, we need to perform these operations manually.</p>
<div class="fragment"><div class="line">m_pImmediateContext-&gt;FinishFrame();</div>
<div class="line">m_Device.ReleaseStaleResources();</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <a href="https://diligentgraphics.com">
        <img class="footer" src="https://github.com/DiligentGraphics/DiligentCore/raw/master/media/diligentgraphics-logo.png" width="99" height="32" alt="Diligent Graphics" />
      </a>
    </li>
  </ul>
</div>
</body>
</html>
